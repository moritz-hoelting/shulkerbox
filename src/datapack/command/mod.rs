//! Represents a command that can be included in a function.

mod execute;

pub use execute::{Condition, Execute};

use chksum_md5 as md5;
use serde::{Deserialize, Serialize};

use crate::util::compile::{CompileOptions, FunctionCompilerState, MutCompilerState};

use super::Function;

/// Represents a command that can be included in a function.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum Command {
    /// A command that is already formatted as a string.
    Raw(String),
    /// Message to be printed only in debug mode
    Debug(String),
    /// Execute command
    Execute(Execute),
    /// Group of commands to be called instantly after each other
    Group(Vec<Command>),
}

impl Command {
    /// Create a new raw command.
    pub fn raw(command: &str) -> Self {
        Self::Raw(command.to_string())
    }

    /// Compile the command into a string.
    pub fn compile(
        &self,
        options: &CompileOptions,
        global_state: &MutCompilerState,
        function_state: &FunctionCompilerState,
    ) -> Vec<String> {
        match self {
            Self::Raw(command) => vec![command.clone()],
            Self::Debug(message) => compile_debug(message, options),
            Self::Execute(ex) => ex.compile(options, global_state, function_state),
            Self::Group(commands) => compile_group(commands, options, global_state, function_state),
        }
    }
}

impl From<&str> for Command {
    fn from(command: &str) -> Self {
        Self::raw(command)
    }
}
impl From<&Function> for Command {
    fn from(value: &Function) -> Self {
        Self::Raw(format!("function {}:{}", value.namespace(), value.name()))
    }
}
impl From<&mut Function> for Command {
    fn from(value: &mut Function) -> Self {
        Self::Raw(format!("function {}:{}", value.namespace(), value.name()))
    }
}

fn compile_debug(message: &str, option: &CompileOptions) -> Vec<String> {
    if option.debug {
        vec![format!(
            r#"tellraw @a [{{"text":"[","color":"dark_blue"}},{{"text":"DEBUG","color":"dark_green","hoverEvent":{{"action":"show_text","value":[{{"text":"Debug message generated by Shulkerbox"}},{{"text":"\nSet debug message to 'false' to disable"}}]}}}},{{"text":"]","color":"dark_blue"}},{{"text":" {}","color":"black"}}]"#,
            message
        )]
    } else {
        Vec::new()
    }
}

fn compile_group(
    commands: &[Command],
    options: &CompileOptions,
    global_state: &MutCompilerState,
    function_state: &FunctionCompilerState,
) -> Vec<String> {
    if commands.len() > 1 {
        let generated_functions = {
            let generated_functions = function_state.generated_functions();
            let amount = generated_functions.get();
            generated_functions.set(amount + 1);

            amount
        };

        let function_path = {
            let pre_hash_path =
                function_state.path().to_owned() + ":" + &generated_functions.to_string();
            let hash = md5::hash(pre_hash_path).to_hex_lowercase();

            "sb/".to_string() + function_state.path() + "/" + &hash[..16]
        };

        let namespace = function_state.namespace();

        let mut function = Function::new(namespace, &function_path);
        function.get_commands_mut().extend(commands.iter().cloned());
        function_state.add_function(&function_path, function);

        vec![format!("function {namespace}:{function_path}")]
    } else {
        commands
            .iter()
            .flat_map(|c| c.compile(options, global_state, function_state))
            .collect()
    }
}
